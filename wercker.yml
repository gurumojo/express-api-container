box: node:slim

no-response-timeout: 15

services:
    - redis

dev:
  steps:
    - npm-install
    - internal/watch:
        code: |
          export REDIS_HOST=$REDIS_PORT_6379_TCP_ADDR
          export REDIS_PORT=$REDIS_PORT_6379_TCP_PORT
          node service
        reload: true

build:
  steps:
    - npm-install
    - npm-test
    - internal/docker-push:
        aws-access-key: $AWS_ACCESS_KEY_ID
        aws-secret-key: $AWS_SECRET_ACCESS_KEY
        aws-region: $AWS_REGION
        aws-registry-id: $AWS_REGISTRY_ID
        repository: $GITHUB_REPOSITORY
        tag: latest, $WERCKER_GIT_COMMIT, $WERCKER_GIT_BRANCH
  after-steps:
    - slack-notifier:
        branch: $SLACK_BRANCH
        channel: $SLACK_CHANNEL
        icon_url: $SLACK_ICON_URL
        notify_on: $SLACK_NOTIFY_ON
        url: $SLACK_URL
        username: $SLACK_USERNAME

deploy:
  box: busybox
  steps:
  steps:
    - script:
        name: testing deploy
        code: node --version
  after-steps:
    - slack-notifier:
        branch: $SLACK_BRANCH
        channel: $SLACK_CHANNEL
        icon_url: $SLACK_ICON_URL
        notify_on: $SLACK_NOTIFY_ON
        url: $SLACK_URL
        username: $SLACK_USERNAME
