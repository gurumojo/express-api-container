box: node:slim

no-response-timeout: 15

services:
    - redis

dev:
  steps:
    #- script:
    #    name: environment
    #    code: env
    #- script:
    #    name: install redis-cli
    #    code: |
    #      apt-get update
    #      apt-get install -y redis-tools
    #- script:
    #    name: wait for redis
    #    code: |
    #      while ! redis-cli --scan -h $REDIS_PORT_6379_TCP_ADDR
    #      </dev/null; do sleep 3; done
    #- internal/shell
    - npm-install
    - internal/watch:
        code: |
          export REDIS_HOST=$REDIS_PORT_6379_TCP_ADDR
          export REDIS_PORT=$REDIS_PORT_6379_TCP_PORT
          node service
        reload: true

build:
  steps:
    - npm-install
    - npm-test
    - script:
        name: version check
        code: |
          echo "node version $(node -v) running"
          echo "npm version $(npm -v) running"

push-to-ecr:
  box: busybox
  steps:
    - internal/docker-push:
        aws-access-key: $AWS_ACCESS_KEY_ID
        aws-secret-key: $AWS_SECRET_ACCESS_KEY
        aws-region: $AWS_REGION
        aws-registry-id: $AWS_REGISTRY_ID
        repository: $REPO
        tag: latest, $WERCKER_GIT_COMMIT, $WERCKER_GIT_BRANCH

deploy:
  steps:
    - script:
        name: testing deploy
        code: node --version
    - npm-install
